/******************** Includes ********************/
#define BLYNK_PRINT Serial                                   // ‡πÉ‡∏´‡πâ Blynk ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏ö‡∏±‡∏Å‡∏≠‡∏≠‡∏Å Serial Monitor
#include <Wire.h>                                            // ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ I2C (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö LCD)
#include <LiquidCrystal_I2C.h>                               // ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° LCD1602 ‡∏ú‡πà‡∏≤‡∏ô I2C
#include <DHT.h>                                             // ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå DHT (Adafruit)
#include <WiFi.h>                                            // ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ Wi-Fi ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ESP32
#include <WiFiClient.h>                                      // ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ TCP client
#include <BlynkSimpleEsp32.h>                                // ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ Blynk 0.6.x ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ESP32
#include <HTTPClient.h>                                      // ‚Üê ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á HTTP ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Telegram Bot API

/******************** LCD ********************/
LiquidCrystal_I2C lcd(0x27, 16, 2);                          // LCD I2C address 0x27 ‡∏Ç‡∏ô‡∏≤‡∏î 16x2 (‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô 0x3F)

/******************** Pins ********************/
#define SOIL_PIN     35                                      // ADC1 ‡∏ä‡πà‡∏≠‡∏á GPIO35 (input-only) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Soil
#define RELAY1_PIN    4                                      // ‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏ä‡πà‡∏≠‡∏á 1
#define RELAY2_PIN    5                                      // ‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏ä‡πà‡∏≠‡∏á 2
#define RELAY3_PIN   18                                      // ‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏ä‡πà‡∏≠‡∏á 3
#define RELAY4_PIN   19                                      // ‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏ä‡πà‡∏≠‡∏á 4
#define DHTPIN       15                                      // ‡∏Ç‡∏≤ DATA ‡∏Ç‡∏≠‡∏á DHT
#define DHTTYPE  DHT11                                       // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó DHT: DHT11 (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô DHT22 ‡πÑ‡∏î‡πâ)
#define STATUS_LED    2                                      // GPIO2: ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Blynk ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÑ‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)

/******************** Sensors ********************/
DHT dht(DHTPIN, DHTTYPE);                                    // ‡∏≠‡∏≠‡∏ö‡πÄ‡∏à‡∏Å‡∏ï‡πå DHT ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®

/******************** Soil Calibration ********************/
const int SOIL_DRY_ADC = 3000;                               // ‡∏Ñ‡πà‡∏≤ ADC ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏¥‡∏ô ‚Äú‡πÅ‡∏´‡πâ‡∏á‡∏°‡∏≤‡∏Å‚Äù (‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á)
const int SOIL_WET_ADC = 1200;                               // ‡∏Ñ‡πà‡∏≤ ADC ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏î‡∏¥‡∏ô ‚Äú‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡∏°‡∏≤‡∏Å‚Äù (‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á)

/******************** Blynk Credentials ********************/
const char ssid[] = "";                                      // ‡∏ä‡∏∑‡πà‡∏≠ Wi-Fi (‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
const char pass[] = "";                                      // ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Wi-Fi (‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
const char auth[] = "";                                      // Blynk Auth Token (‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏õ Blynk)
const char BLYNK_SERVER_IP[] = "";                           // IP ‡∏Ç‡∏≠‡∏á Blynk Local Server
const uint16_t BLYNK_SERVER_PORT = 8080;                     // ‡∏û‡∏≠‡∏£‡πå‡∏ï‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå (‡∏õ‡∏Å‡∏ï‡∏¥ 8080)

/******************** Timers ********************/
BlynkTimer timer;                                            // ‡∏ï‡∏±‡∏ß‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ non-blocking ‡∏Ç‡∏≠‡∏á Blynk
const unsigned long DHT_INTERVAL_MS   = 2000;                // ‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡πà‡∏≤‡∏ô DHT (ms) ‚Äî DHT11 ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‚â• 2000ms
const unsigned long SOIL_INTERVAL_MS  = 1000;                // ‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡πà‡∏≤‡∏ô Soil (ms)
const unsigned long RECONN_INTERVAL_MS = 5000;               // ‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wi-Fi/Blynk ‡πÉ‡∏´‡∏°‡πà (ms)

/******************** Forward Declarations ********************/
void taskReadAndDisplay();                                    // ‡∏≠‡πà‡∏≤‡∏ô DHT/Soil ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Serial + LCD (‡∏ó‡∏≥‡πÄ‡∏™‡∏°‡∏≠)
void taskSendToBlynk();                                       // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô Blynk ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß
void taskReconnect();                                         // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wi-Fi/Blynk ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞
void showNetStatus();                                         // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏ö‡∏ô LCD ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á

/************* Telegram Settings (‡πÄ‡∏û‡∏¥‡πà‡∏°) *************/
const char TELEGRAM_BOT_TOKEN[] = "";                         // ‚Üê ‡πÉ‡∏™‡πà Token ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó Telegram
const char TELEGRAM_CHAT_ID[]  = "";                          // ‚Üê ‡πÉ‡∏™‡πà Chat ID ‡∏´‡∏£‡∏∑‡∏≠ Group ID ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
float tempThreshold = 30.0;                                   // ‚Üê ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ (¬∞C)
float humidityThreshold = 40.0;                               // ‚Üê ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ (%RH)
float soilThreshold = 30.0;                  // ‚Üê ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô "‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤" ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÅ‡∏´‡πâ‡∏á (%)

const unsigned long ALERT_COOLDOWN_MS = 60000UL;              // ‚Üê ‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏õ‡∏°: ‡∏™‡πà‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ã‡πâ‡∏≥‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ó‡∏∏‡∏Å 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
unsigned long lastTempAlertMs = 0;                            // ‚Üê ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (ms)
unsigned long lastHumiAlertMs = 0;                            // ‚Üê ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (ms)
unsigned long lastSoilAlertMs = 0;                  // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Soil ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö ALERT_COOLDOWN_MS)

/******************** Setup ********************/
void setup() {
  Serial.begin(9600);                                         // ‡πÄ‡∏õ‡∏¥‡∏î Serial Monitor ‡∏ó‡∏µ‡πà 9600 bps
  dht.begin();                                                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå DHT

  pinMode(SOIL_PIN, INPUT);                                   // ‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡∏≤ Soil ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï
  pinMode(RELAY1_PIN, OUTPUT);                                // ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 1 ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡∏û‡∏∏‡∏ï
  pinMode(RELAY2_PIN, OUTPUT);                                // ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 2 ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡∏û‡∏∏‡∏ï
  pinMode(RELAY3_PIN, OUTPUT);                                // ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 3 ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡∏û‡∏∏‡∏ï
  pinMode(RELAY4_PIN, OUTPUT);                                // ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 4 ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡∏û‡∏∏‡∏ï
  digitalWrite(RELAY1_PIN, LOW);                              // ‡∏õ‡∏¥‡∏î‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 1 ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° (‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏° Active-LOW/HIGH ‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏à‡∏£‡∏¥‡∏á)
  digitalWrite(RELAY2_PIN, LOW);                              // ‡∏õ‡∏¥‡∏î‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 2 ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
  digitalWrite(RELAY3_PIN, LOW);                              // ‡∏õ‡∏¥‡∏î‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 3 ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
  digitalWrite(RELAY4_PIN, LOW);                              // ‡∏õ‡∏¥‡∏î‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 4 ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°

  pinMode(STATUS_LED, OUTPUT);                                // ‡∏ï‡∏±‡πâ‡∏á GPIO2 ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡∏û‡∏∏‡∏ï
  digitalWrite(STATUS_LED, LOW);                              // ‡∏î‡∏±‡∏ö‡πÑ‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå Blynk)

  lcd.begin();                                                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≠ LCD (‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ô loop)
  lcd.backlight();                                            // ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
  lcd.clear();                                                // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  lcd.setCursor(0, 0);                                        // ‡πÑ‡∏õ‡πÅ‡∏ñ‡∏ß 1 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 0
  lcd.print("Booting...");                                    // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏π‡∏ï
  lcd.setCursor(0, 1);                                        // ‡πÑ‡∏õ‡πÅ‡∏ñ‡∏ß 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 0
  lcd.print("WiFi: connecting");                              // ‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Wi-Fi

  WiFi.begin(ssid, pass);                                     // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wi-Fi (‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å)
  WiFi.setAutoReconnect(true);                                // ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≠ Wi-Fi ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏∏‡∏î
  WiFi.persistent(true);                                      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å config ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡∏ñ‡∏≤‡∏ß‡∏£

  Blynk.config(auth, BLYNK_SERVER_IP, BLYNK_SERVER_PORT);     // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á Blynk (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà connect ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
  // ‡πÉ‡∏ä‡πâ Blynk.config + Blynk.connect(timeout) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡πâ‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡∏•‡πà‡∏°

  timer.setInterval(DHT_INTERVAL_MS,  taskReadAndDisplay);    // ‡∏≠‡πà‡∏≤‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏ó‡∏≥‡πÄ‡∏™‡∏°‡∏≠)
  timer.setInterval(DHT_INTERVAL_MS,  taskSendToBlynk);       // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ Blynk ‡∏ó‡∏∏‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠)
  timer.setInterval(RECONN_INTERVAL_MS, taskReconnect);       // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Wi-Fi/Blynk ‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}

/******************** Blynk Connected Callback ********************/
BLYNK_CONNECTED() {
  Serial.println("Blynk connected!");                         // ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πà‡∏≠ Blynk ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
  Blynk.syncAll();                                            // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Virtual Pins ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  digitalWrite(STATUS_LED, HIGH);                             // ‡πÄ‡∏õ‡∏¥‡∏î GPIO2 ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
  lcd.setCursor(0, 1);                                        // ‡πÑ‡∏õ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á
  lcd.print("Blynk: online   ");                              // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏ö‡πÄ‡∏®‡∏©‡∏≠‡∏±‡∏Å‡∏©‡∏£)
}

/******************** Relay Controls via Blynk (V10‚ÄìV13) ********************/
BLYNK_WRITE(V10) {                                            // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 1 ‡∏ó‡∏µ‡πà V10
  int st = param.asInt();                                     // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ 0/1
  digitalWrite(RELAY1_PIN, st);                               // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏∂‡∏á‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 1 (‡∏ñ‡πâ‡∏≤ Active-LOW ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ !st)
  Serial.print("Relay 1 ‚Üí "); Serial.println(st ? "ON" : "OFF"); // ‡∏î‡∏µ‡∏ö‡∏±‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
}

BLYNK_WRITE(V11) {                                            // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 2 ‡∏ó‡∏µ‡πà V11
  int st = param.asInt();                                     // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ 0/1
  digitalWrite(RELAY2_PIN, st);                               // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏∂‡∏á‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 2
  Serial.print("Relay 2 ‚Üí "); Serial.println(st ? "ON" : "OFF"); // ‡∏î‡∏µ‡∏ö‡∏±‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
}

BLYNK_WRITE(V12) {                                            // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 3 ‡∏ó‡∏µ‡πà V12
  int st = param.asInt();                                     // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ 0/1
  digitalWrite(RELAY3_PIN, st);                               // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏∂‡∏á‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 3
  Serial.print("Relay 3 ‚Üí "); Serial.println(st ? "ON" : "OFF"); // ‡∏î‡∏µ‡∏ö‡∏±‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
}

BLYNK_WRITE(V13) {                                            // ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 4 ‡∏ó‡∏µ‡πà V13
  int st = param.asInt();                                     // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ 0/1
  digitalWrite(RELAY4_PIN, st);                               // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡∏∂‡∏á‡∏£‡∏µ‡πÄ‡∏•‡∏¢‡πå 4
  Serial.print("Relay 4 ‚Üí "); Serial.println(st ? "ON" : "OFF"); // ‡∏î‡∏µ‡∏ö‡∏±‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
}

// ******************** Threshold Controls via Blynk (Slider V30, V31) ********************
BLYNK_WRITE(V30) {                           // ‡∏Ñ‡∏≠‡∏•‡πÅ‡∏ö‡πá‡∏Å‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Slider ‡∏ó‡∏µ‡πà Virtual Pin V30 (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥)
  float v = param.asFloat();                 // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡πá‡∏ô float
  if (!isnan(v)) {                           // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (NaN)
    tempThreshold = constrain(v, 0.0f, 80.0f); // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ä‡πà‡∏ß‡∏á 0‚Äì80¬∞C ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•
    Serial.print("Set Temp Threshold: ");    // ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á Serial ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    Serial.print(tempThreshold);             
    Serial.println(" ¬∞C");                   
  }
}

BLYNK_WRITE(V31) {                           // ‡∏Ñ‡∏≠‡∏•‡πÅ‡∏ö‡πá‡∏Å‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Slider ‡∏ó‡∏µ‡πà Virtual Pin V31 (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô)
  float v = param.asFloat();                 // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡πá‡∏ô float
  if (!isnan(v)) {                           // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (NaN)
    humidityThreshold = constrain(v, 0.0f, 100.0f); // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ä‡πà‡∏ß‡∏á 0‚Äì100%RH
    Serial.print("Set Humi Threshold: ");    // ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á Serial ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    Serial.print(humidityThreshold);         
    Serial.println(" %");                    
  }
}

// ******************** Threshold Controls via Blynk (Slider V32: Soil %) ********************
BLYNK_WRITE(V32) {                           // ‡∏Ñ‡∏≠‡∏•‡πÅ‡∏ö‡πá‡∏Å‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Slider ‡∏ó‡∏µ‡πà Virtual Pin V32 (‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô)
  float v = param.asFloat();                 // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡πá‡∏ô float
  if (!isnan(v)) {                           // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô NaN (‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
    soilThreshold = constrain(v, 0.0f, 100.0f); // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ä‡πà‡∏ß‡∏á 0‚Äì100% ‡πÉ‡∏´‡πâ‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•
    Serial.print("Set Soil Threshold: ");    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô Serial ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
    Serial.print(soilThreshold);             
    Serial.println(" %");                    
  }
}

/******************** Periodic Tasks ********************/
void taskReadAndDisplay() {
  float h = dht.readHumidity();                               // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏® (%RH)
  float t = dht.readTemperature();                            // ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)
  int soilRaw = analogRead(SOIL_PIN);                         // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ ADC ‡∏Ç‡∏≠‡∏á Soil (0‚Äì4095)
  int span = SOIL_DRY_ADC - SOIL_WET_ADC;                     // ‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏£‡∏ï (‡πÅ‡∏´‡πâ‡∏á-‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å)
  if (span <= 0) span = 1;                                    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏®‡∏π‡∏ô‡∏¢‡πå
  int soilPct = (int)(((float)(SOIL_DRY_ADC - soilRaw) * 100.0f) / span); // map ‡∏î‡∏¥‡∏ö‚Üí%
  soilPct = constrain(soilPct, 0, 100);                       // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ä‡πà‡∏ß‡∏á 0‚Äì100%

  Serial.print("T: "); Serial.print(t); Serial.print(" C | "); // ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏•‡∏á Serial
  Serial.print("H: "); Serial.print(h); Serial.print(" % | "); // ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏•‡∏á Serial
  Serial.print("Soil: "); Serial.print(soilPct); Serial.println(" %"); // ‡∏û‡∏¥‡∏°‡∏û‡πå Soil% ‡∏•‡∏á Serial

  lcd.setCursor(0, 0);                                        // ‡πÑ‡∏õ‡∏ï‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å
  lcd.print("T:");                                            // ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥
  if (isnan(t)) lcd.print("--.-"); else lcd.print(t, 1);       // ‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏™‡∏î‡∏á --.- ‡∏°‡∏¥‡∏â‡∏∞‡∏ô‡∏±‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 1 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
  lcd.print((char)223); lcd.print("C ");                      // ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå ¬∞C
  lcd.print("H:");                                            // ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô
  if (isnan(h)) lcd.print("--.-"); else lcd.print(h, 0);       // ‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏™‡∏î‡∏á --.- ‡∏°‡∏¥‡∏â‡∏∞‡∏ô‡∏±‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°
  lcd.print("%");                                             // ‡∏´‡∏ô‡πà‡∏ß‡∏¢ %

  lcd.setCursor(0, 1);                                        // ‡πÑ‡∏õ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á
  lcd.print("Soil:");                                         // ‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡∏≥‡∏Å‡∏±‡∏ö Soil
  lcd.print(soilPct);                                         // ‡πÅ‡∏™‡∏î‡∏á Soil%
  lcd.print("%    ");                                         // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏®‡∏©‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ñ‡πâ‡∏≤‡∏á

  showNetStatus();                                            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢ (‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡πâ‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ)

  /***** ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram (‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å loop) *****/
  if (!isnan(t) && (t > tempThreshold)) {                     // ‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
    if (millis() - lastTempAlertMs >= ALERT_COOLDOWN_MS) {    // ‡πÄ‡∏ä‡πá‡∏Å cooldown ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏õ‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      String msg = "üî• Temp High: " + String(t, 1) + "¬∞C (>" + String(tempThreshold, 1) + "¬∞C)"; // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      sendTelegramMessage(msg);                               // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ Telegram
      lastTempAlertMs = millis();                              // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    }
  }
  if (!isnan(h) && (h < humidityThreshold)) {                 // ‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
    if (millis() - lastHumiAlertMs >= ALERT_COOLDOWN_MS) {    // ‡πÄ‡∏ä‡πá‡∏Å cooldown ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏õ‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      String msg = "üíß Humidity Low: " + String(h, 0) + "% (<" + String(humidityThreshold, 0) + "%)"; // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      sendTelegramMessage(msg);                               // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ Telegram
      lastHumiAlertMs = millis();                              // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    }
  }

  /* ====== ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏•‡πá‡∏≠‡∏Å Soil Alert ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ====== */
  if (soilPct < soilThreshold) {                               // ‡∏ñ‡πâ‡∏≤ % ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ (‡πÅ‡∏´‡πâ‡∏á)
    if (millis() - lastSoilAlertMs >= ALERT_COOLDOWN_MS) {     // ‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏õ‡∏°: ‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á cooldown ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
      String msg = "üå± Soil Low: " + String(soilPct) + "% (< " // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤ Soil ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                   + String(soilThreshold) + "%)";             // ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ
      sendTelegramMessage(msg);                                 // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ Telegram
      lastSoilAlertMs = millis();                               // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á Soil ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏° cooldown
    }
  }
  /* ====== ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° ====== */
}


void taskSendToBlynk() {
  if (!Blynk.connected()) return;                             // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Blynk ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏° (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏ï‡πà‡∏≠)
  float h = dht.readHumidity();                               // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
  float t = dht.readTemperature();                            // ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥
  int soilRaw = analogRead(SOIL_PIN);                         // ‡∏≠‡πà‡∏≤‡∏ô Soil ADC
  int span = SOIL_DRY_ADC - SOIL_WET_ADC; if (span <= 0) span = 1; // ‡∏Å‡∏±‡∏ô‡∏´‡∏≤‡∏£ 0
  int soilPct = (int)(((float)(SOIL_DRY_ADC - soilRaw) * 100.0f) / span); // map ‚Üí %
  soilPct = constrain(soilPct, 0, 100);                       // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ä‡πà‡∏ß‡∏á

  if (!isnan(t)) Blynk.virtualWrite(V1, t);                   // ‡∏™‡πà‡∏á‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÑ‡∏õ V1 (‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ)
  if (!isnan(h)) Blynk.virtualWrite(V2, h);                   // ‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÑ‡∏õ V2 (‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ)
  Blynk.virtualWrite(V3, soilPct);                            // ‡∏™‡πà‡∏á Soil% ‡πÑ‡∏õ V3
}

void taskReconnect() {
  if (WiFi.status() != WL_CONNECTED) {                        // ‡∏ñ‡πâ‡∏≤ Wi-Fi ‡∏´‡∏•‡∏∏‡∏î
    Serial.println("Wi-Fi disconnected ‚Üí reconnecting...");   // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    WiFi.begin(ssid, pass);                                   // ‡∏Ç‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô timer)
    lcd.setCursor(0, 1); lcd.print("WiFi: reconnect  ");      // ‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏ô LCD
    digitalWrite(STATUS_LED, LOW);                            // ‡∏î‡∏±‡∏ö‡πÑ‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Blynk
  }
  if (WiFi.status() == WL_CONNECTED && !Blynk.connected()) {  // ‡∏ñ‡πâ‡∏≤ Wi-Fi ‡∏ï‡∏¥‡∏î ‡πÅ‡∏ï‡πà Blynk ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î
    Serial.println("Blynk reconnecting...");                  // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    Blynk.connect(3000);                                      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Blynk ‡πÇ‡∏î‡∏¢ timeout 3s (‡πÑ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ô‡∏≤‡∏ô)
    if (!Blynk.connected()) {                                 // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î
      lcd.setCursor(0, 1); lcd.print("Blynk: offline ");      // ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå
      digitalWrite(STATUS_LED, LOW);                          // ‡∏î‡∏±‡∏ö‡πÑ‡∏ü‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    }
  }
}

/******************** Helper: show Wi-Fi/Blynk status (suffix on line 2) ********************/
void showNetStatus() {
  lcd.setCursor(11, 1);                                       // ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 11‚Äì15)
  if (WiFi.status() == WL_CONNECTED) {                        // ‡∏ñ‡πâ‡∏≤ Wi-Fi ‡∏ï‡∏¥‡∏î
    if (Blynk.connected()) lcd.print("Onln");                 // ‡∏ï‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà ‚Üí ‡πÅ‡∏™‡∏î‡∏á Onln (Online)
    else                   lcd.print("WiFi");                 // ‡∏°‡∏µ Wi-Fi ‡πÅ‡∏ï‡πà Blynk ‡∏´‡∏•‡∏∏‡∏î ‚Üí WiFi
  } else {
    lcd.print("Off ");                                        // ‡πÑ‡∏°‡πà‡∏°‡∏µ Wi-Fi ‚Üí Off
  }
}

/******************** Main Loop ********************/
void loop() {
  if (Blynk.connected()) {                                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Blynk ‡πÑ‡∏î‡πâ
    Blynk.run();                                              // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Blynk (‡∏Ñ‡∏≠‡∏•‡πÅ‡∏ö‡πá‡∏Å, sync)
  }
  timer.run();                                                // ‡∏£‡∏±‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (‡∏≠‡πà‡∏≤‡∏ô/‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤/‡∏£‡∏µ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ô‡πá‡∏Å‡∏ï‡πå)
}

/******************** Helper: Telegram Sender (‡πÄ‡∏û‡∏¥‡πà‡∏°) ********************/
bool sendTelegramMessage(const String& text) {                 // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ Telegram; ‡∏Ñ‡∏∑‡∏ô true ‡∏ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
  if (WiFi.status() != WL_CONNECTED) {                         // ‡∏ñ‡πâ‡∏≤ Wi-Fi ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°
    Serial.println("Skip Telegram: no WiFi");                 // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á (‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡πâ‡∏≤‡∏á)
    return false;                                             // ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
  }
  HTTPClient http;                                            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≠‡∏ö‡πÄ‡∏à‡∏Å‡∏ï‡πå HTTP
  String url = String("https://api.telegram.org/bot") + TELEGRAM_BOT_TOKEN + "/sendMessage"; // Endpoint ‡∏Ç‡∏≠‡∏á Telegram Bot
  String body = String("{\"chat_id\":\"") + TELEGRAM_CHAT_ID + "\",\"text\":\"" + text + "\"}"; // ‡∏™‡∏£‡πâ‡∏≤‡∏á payload ‡πÅ‡∏ö‡∏ö JSON
  http.begin(url);                                            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
  http.addHeader("Content-Type", "application/json");         // ‡∏ï‡∏±‡πâ‡∏á header ‡πÄ‡∏õ‡πá‡∏ô JSON
  int code = http.POST(body);                                 // ‡∏™‡πà‡∏á POST ‡∏û‡∏£‡πâ‡∏≠‡∏° body
  Serial.print("Telegram HTTP code: "); Serial.println(code); // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö HTTP
  http.end();                                                 // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ HTTP
  return (code >= 200 && code < 300);                         // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏´‡∏±‡∏™ 2xx
}
